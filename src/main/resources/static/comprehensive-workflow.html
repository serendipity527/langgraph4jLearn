<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangGraph4j ç»¼åˆç¤ºä¾‹ (å«å­å›¾+å¤šæ™ºèƒ½ä½“)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .node-active { animation: pulse 1s infinite; box-shadow: 0 0 15px currentColor; }
        .node-completed { background: rgba(34,197,94,0.3) !important; border-color: #22c55e !important; }
        .node-waiting { animation: blink 0.8s infinite; }
        @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.7;transform:scale(1.05)} }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
        .subgraph-box { border: 2px dashed #8b5cf6; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-4">
            <h1 class="text-xl font-bold text-blue-400">LangGraph4j ç»¼åˆç¤ºä¾‹</h1>
<p class="text-gray-400 text-xs">StateGraph | SubGraph | Multi-Agent | Node | Edge | Conditional Edge | HITL | Cycle</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
            <!-- å·¦ä¾§æ§åˆ¶ -->
            <div class="space-y-3">
                <div class="bg-gray-800 rounded-lg p-3">
                    <h2 class="font-semibold mb-2 text-blue-400 text-sm">æ§åˆ¶é¢æ¿</h2>
                    <div class="mb-2">
                        <label class="text-xs text-gray-400">Thread ID</label>
                        <input type="text" id="threadIdInput" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm font-mono" value="demo-thread">
                    </div>
                    <div class="mb-2">
                        <label class="text-xs text-gray-400">ç”¨æˆ·è¾“å…¥</label>
                        <input type="text" id="userInput" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" placeholder="è¾“å…¥æŒ‡ä»¤...">
                    </div>
                    <div class="text-xs text-gray-500 mb-2 space-y-1">
                        <p class="text-gray-400 font-bold">å•å·¥ä½œæµç¤ºä¾‹:</p>
                        <p class="cursor-pointer hover:text-blue-400" onclick="setInput('æŸ¥è¯¢å¤©æ°”')">â€¢ æŸ¥è¯¢å¤©æ°” (å®‰å…¨)</p>
                        <p class="cursor-pointer hover:text-blue-400" onclick="setInput('ä½¿ç”¨å·¥å…·è®¡ç®—')">â€¢ ä½¿ç”¨å·¥å…·è®¡ç®— (å·¥å…·/Cycle)</p>
                        <p class="cursor-pointer hover:text-green-400" onclick="setInput('å¥åº·å’¨è¯¢å¤´ç—›')">â€¢ å¥åº·å’¨è¯¢å¤´ç—› (å­å›¾)</p>
                        <p class="cursor-pointer hover:text-red-400" onclick="setInput('åˆ é™¤æ•°æ®')">â€¢ åˆ é™¤æ•°æ® (å±é™©/HITL)</p>
                    </div>
                    <div class="flex gap-2 mb-2">
                        <button onclick="executeInvoke()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-1 rounded text-xs">åŒæ­¥æ‰§è¡Œ</button>
                        <button onclick="executeStream()" class="flex-1 bg-purple-600 hover:bg-purple-700 py-1 rounded text-xs">æµå¼æ‰§è¡Œ</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="startWithThread()" class="flex-1 bg-cyan-600 hover:bg-cyan-700 py-1 rounded text-xs" title="å¸¦è®°å¿†ä½†ä¸ä¸­æ–­">ğŸ’¾ ThreadIdæ‰§è¡Œ</button>
                        <button onclick="startWithHitl()" class="flex-1 bg-orange-600 hover:bg-orange-700 py-1 rounded text-xs" title="å±é™©æ“ä½œä¼šä¸­æ–­ç­‰å¾…å®¡æ‰¹">ğŸ”’ äººåœ¨å›è·¯(HITL)</button>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-lg p-3 border border-purple-500/30">
                    <h2 class="font-semibold mb-2 text-purple-400 text-sm">è®°å¿†æŸ¥çœ‹</h2>
                    <div class="flex gap-2 mb-2">
                        <button onclick="loadMemory()" class="flex-1 bg-purple-600 hover:bg-purple-700 py-1 rounded text-xs">æŸ¥çœ‹è®°å¿†</button>
                        <button onclick="continueThread()" class="flex-1 bg-green-600 hover:bg-green-700 py-1 rounded text-xs">ç»§ç»­æ‰§è¡Œ</button>
                    </div>
                    <div id="memoryPanel" class="bg-gray-900 rounded p-2 text-xs max-h-32 overflow-y-auto">
                        <p class="text-gray-500">è¾“å…¥ThreadIdåç‚¹å‡»"æŸ¥çœ‹è®°å¿†"</p>
                    </div>
                </div>

                <div id="approvalPanel" class="bg-gray-800 rounded-lg p-3 hidden">
                    <h2 class="font-semibold mb-2 text-yellow-400 text-sm">äººå·¥å®¡æ‰¹</h2>
                    <p id="approvalMsg" class="text-xs text-gray-300 mb-2"></p>
                    <div class="flex gap-2">
                        <button onclick="handleApproval('approve')" class="flex-1 bg-green-600 hover:bg-green-700 py-1 rounded text-xs">æ‰¹å‡†</button>
                        <button onclick="handleApproval('reject')" class="flex-1 bg-red-600 hover:bg-red-700 py-1 rounded text-xs">æ‹’ç»</button>
                    </div>
                </div>

                <!-- å¤šæ™ºèƒ½ä½“æ§åˆ¶é¢æ¿ -->
                <div class="bg-gray-800 rounded-lg p-3 border border-amber-500/30">
                    <h2 class="font-semibold mb-2 text-amber-400 text-sm">ğŸ¤– å¤šæ™ºèƒ½ä½“åä½œ</h2>
                    <div class="text-xs text-gray-500 mb-2">
                        <p class="cursor-pointer hover:text-amber-400" onclick="setInput('å…¨éƒ¨æ™ºèƒ½ä½“åä½œåˆ†æ')">â€¢ å…¨éƒ¨æ™ºèƒ½ä½“åä½œåˆ†æ</p>
                    </div>
                    <div class="text-xs text-gray-400 mb-1">é“¾å¼æ‰§è¡Œ (Supervisoræ¨¡å¼):</div>
                    <div class="flex gap-2 mb-2">
                        <button onclick="multiAgentInvoke()" class="flex-1 bg-amber-600 hover:bg-amber-700 py-1 rounded text-xs">ğŸ”— é“¾å¼åŒæ­¥</button>
                        <button onclick="multiAgentStream()" class="flex-1 bg-amber-700 hover:bg-amber-800 py-1 rounded text-xs">ğŸ”— é“¾å¼æµå¼</button>
                    </div>
                    <div class="text-xs text-green-400 mb-1">âš¡ å¹¶è¡Œæ‰§è¡Œ (Parallelæ¨¡å¼):</div>
                    <div class="flex gap-2">
                        <button onclick="parallelAgentInvoke()" class="flex-1 bg-green-600 hover:bg-green-700 py-1 rounded text-xs">âš¡ å¹¶è¡ŒåŒæ­¥</button>
                        <button onclick="parallelAgentStream()" class="flex-1 bg-green-700 hover:bg-green-800 py-1 rounded text-xs">âš¡ å¹¶è¡Œæµå¼</button>
                    </div>
                </div>

                <!-- Adaptive RAG æ§åˆ¶é¢æ¿ -->
                <div class="bg-gray-800 rounded-lg p-3 border border-rose-500/30">
                    <h2 class="font-semibold mb-2 text-rose-400 text-sm">ğŸ“– Adaptive RAG (è‡ªé€‚åº”æ£€ç´¢)</h2>
                    <div class="text-xs text-gray-500 mb-2 space-y-1">
                        <p class="cursor-pointer hover:text-rose-400" onclick="setInput('ä»€ä¹ˆæ˜¯AI')">â€¢ ä»€ä¹ˆæ˜¯AI (ç®€å•â†’ç›´æ¥ç”Ÿæˆ)</p>
                        <p class="cursor-pointer hover:text-rose-400" onclick="setInput('LangGraphçš„ä½¿ç”¨æ–¹æ³•')">â€¢ LangGraphä½¿ç”¨æ–¹æ³• (æ ‡å‡†RAG)</p>
                        <p class="cursor-pointer hover:text-rose-400" onclick="setInput('æ¯”è¾ƒåˆ†æRAGå’ŒFine-tuningçš„ä¼˜åŠ£')">â€¢ æ¯”è¾ƒRAGå’ŒFine-tuning (å¤æ‚â†’å¤šæ­¥æ£€ç´¢)</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="adaptiveRagInvoke()" class="flex-1 bg-rose-600 hover:bg-rose-700 py-1 rounded text-xs">ğŸ“– RAGåŒæ­¥</button>
                        <button onclick="adaptiveRagStream()" class="flex-1 bg-rose-700 hover:bg-rose-800 py-1 rounded text-xs">ğŸ“– RAGæµå¼</button>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´å·¥ä½œæµå›¾ -->
            <div class="bg-gray-800 rounded-lg p-3">
                <h2 class="font-semibold mb-2 text-purple-400 text-sm">å·¥ä½œæµå›¾ <span id="graphStatus" class="text-xs font-normal text-gray-500">(å°±ç»ª)</span></h2>
                <div class="flex flex-col items-center space-y-1 text-xs">
                    <div id="n-__START__" class="bg-green-900 border-2 border-green-500 px-2 py-0.5 rounded font-bold">START</div>
                    <div class="text-gray-600">â†“</div>
                    <div id="n-input_processor" class="bg-blue-900 border border-blue-500 px-2 py-0.5 rounded">input</div>
                    <div class="text-gray-600">â†“</div>
                    <div id="n-intent_classifier" class="bg-purple-900 border border-purple-500 px-2 py-0.5 rounded">intent</div>
                    <div class="text-gray-500 text-xs">â†“ æ¡ä»¶è·¯ç”±</div>
                    <div class="grid grid-cols-4 gap-1 w-full text-center">
                        <div class="space-y-1">
                            <div class="text-gray-500 text-[10px]">safe</div>
                            <div id="n-safe_operation" class="bg-green-900 border border-green-500 px-1 py-0.5 rounded text-[10px]">safe</div>
                        </div>
                        <div class="space-y-1">
                            <div class="text-gray-500 text-[10px]">tool</div>
                            <div id="n-tool_executor" class="bg-cyan-900 border border-cyan-500 px-1 py-0.5 rounded text-[10px]">tool</div>
                            <div class="text-gray-600 text-[10px]">â†“</div>
                            <div id="n-validation" class="bg-cyan-900 border border-cyan-500 px-1 py-0.5 rounded text-[10px]">valid</div>
                            <div class="text-yellow-500 text-[10px]">â†©Cycle</div>
                        </div>
                        <div class="space-y-1 subgraph-box rounded p-1 bg-purple-900/20">
                            <div class="text-purple-400 text-[10px] font-bold">ğŸ¥ å¥åº·å­å›¾ (SubGraph)</div>
                            <div id="n-health_subgraph" class="bg-purple-900 border border-purple-500 px-1 py-0.5 rounded text-[10px] mb-1">health_subgraph</div>
                            <!-- å­å›¾å†…éƒ¨ç»“æ„ -->
                            <div class="bg-gray-800/50 rounded p-1 space-y-0.5">
                                <div id="n-sg-health_triage" class="bg-pink-900/60 border border-pink-500 px-1 py-0.5 rounded text-[9px]">triage</div>
                                <div class="text-purple-400 text-[8px]">â†“ æ¡ä»¶è·¯ç”±</div>
                                <div class="flex gap-0.5 text-[8px]">
                                    <div id="n-sg-symptom_analysis" class="flex-1 bg-red-900/50 border border-red-400 px-0.5 py-0.5 rounded text-center">ğŸ©º sym</div>
                                    <div id="n-sg-nutrition_advice" class="flex-1 bg-green-900/50 border border-green-400 px-0.5 py-0.5 rounded text-center">ğŸ¥— nut</div>
                                    <div id="n-sg-exercise_plan" class="flex-1 bg-blue-900/50 border border-blue-400 px-0.5 py-0.5 rounded text-center">ğŸƒ exe</div>
                                </div>
                                <div class="text-purple-400 text-[8px]">â†“</div>
                                <div id="n-sg-health_summary" class="bg-pink-900/60 border border-pink-500 px-1 py-0.5 rounded text-[9px]">summary</div>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <div class="text-gray-500 text-[10px]">danger</div>
                            <div id="n-approval_request" class="bg-yellow-900 border border-yellow-500 px-1 py-0.5 rounded text-[10px]">approval</div>
                            <div class="text-red-400 text-[10px]">âš¡HITL</div>
                            <div id="n-approval_handler" class="bg-yellow-900 border border-yellow-500 px-1 py-0.5 rounded text-[10px]">handler</div>
                        </div>
                    </div>
                    <div class="text-gray-600">â†“</div>
                    <div id="n-result_aggregator" class="bg-indigo-900 border border-indigo-500 px-2 py-0.5 rounded">result</div>
                    <div class="text-gray-600">â†“</div>
                    <div id="n-__END__" class="bg-red-900 border border-red-500 px-2 py-0.5 rounded font-bold">END</div>
                </div>
                <div class="mt-2 p-2 bg-gray-900/50 rounded text-xs">
                    <div class="text-gray-500 mb-1">æ‰§è¡Œè·¯å¾„:</div>
                    <div id="executionPath" class="text-green-400 font-mono flex flex-wrap gap-1">
                        <span class="text-gray-600">ç­‰å¾…...</span>
                    </div>
                </div>
                <div class="mt-2 p-2 bg-gray-900 rounded text-xs grid grid-cols-2 gap-1">
                    <div>èŠ‚ç‚¹: <span id="dispNode" class="text-blue-400">-</span></div>
                    <div>æ„å›¾: <span id="dispIntent" class="text-purple-400">-</span></div>
                    <div>æ­¥æ•°: <span id="dispStep" class="text-green-400">0</span></div>
                    <div>çŠ¶æ€: <span id="dispStatus" class="text-yellow-400">idle</span></div>
                </div>

                <!-- é“¾å¼å¤šæ™ºèƒ½ä½“å·¥ä½œæµå›¾ -->
                <div id="multiAgentGraph" class="mt-3 p-2 bg-gray-900/50 rounded border border-amber-500/30 hidden">
                    <div class="text-amber-400 text-xs font-bold mb-2">ğŸ”— é“¾å¼å¤šæ™ºèƒ½ä½“ (Supervisoræ¨¡å¼)</div>
                    <div class="flex flex-col items-center space-y-1 text-xs">
                        <div id="n-ma-__START__" class="bg-green-900 border border-green-500 px-2 py-0.5 rounded font-bold">START</div>
                        <div class="text-gray-600">â†“</div>
                        <div id="n-ma-supervisor" class="bg-amber-900 border-2 border-amber-500 px-3 py-1 rounded">ğŸ‘” Supervisor</div>
                        <div class="text-amber-400 text-[10px]">â†“ é“¾å¼åˆ†å‘</div>
                        <div class="flex flex-col items-center space-y-1">
                            <div id="n-ma-research_agent" class="bg-blue-900 border border-blue-400 px-2 py-0.5 rounded">ğŸ” Research</div>
                            <div class="text-gray-500">â†“</div>
                            <div id="n-ma-analyst_agent" class="bg-purple-900 border border-purple-400 px-2 py-0.5 rounded">ğŸ“Š Analyst</div>
                            <div class="text-gray-500">â†“</div>
                            <div id="n-ma-writer_agent" class="bg-pink-900 border border-pink-400 px-2 py-0.5 rounded">âœï¸ Writer</div>
                        </div>
                        <div class="text-gray-600">â†“</div>
                        <div id="n-ma-aggregator" class="bg-indigo-900 border border-indigo-500 px-2 py-0.5 rounded">ğŸ“‹ Aggregator</div>
                        <div class="text-gray-600">â†“</div>
                        <div id="n-ma-__END__" class="bg-red-900 border border-red-500 px-2 py-0.5 rounded font-bold">END</div>
                    </div>
                </div>

                <!-- å¹¶è¡Œå¤šæ™ºèƒ½ä½“å·¥ä½œæµå›¾ -->
                <div id="parallelAgentGraph" class="mt-3 p-2 bg-gray-900/50 rounded border border-green-500/30 hidden">
                    <div class="text-green-400 text-xs font-bold mb-2">âš¡ å¹¶è¡Œå¤šæ™ºèƒ½ä½“ (Parallelæ¨¡å¼)</div>
                    <div class="flex flex-col items-center space-y-1 text-xs">
                        <div id="n-pa-__START__" class="bg-green-900 border border-green-500 px-2 py-0.5 rounded font-bold">START</div>
                        <div class="text-gray-600">â†“</div>
                        <div id="n-pa-dispatcher" class="bg-green-900 border-2 border-green-500 px-3 py-1 rounded">ğŸ“¤ Dispatcher</div>
                        <div class="text-green-400 text-[10px]">â†“ å¹¶è¡Œåˆ†å‘</div>
                        <div id="n-pa-parallel_executor" class="border-2 border-dashed border-green-500 rounded p-2 bg-green-900/20">
                            <div class="text-green-300 text-[10px] mb-1 text-center">âš¡ åŒæ—¶æ‰§è¡Œ</div>
                            <div class="flex gap-2">
                                <div id="n-pa-research" class="bg-blue-900 border border-blue-400 px-2 py-0.5 rounded">ğŸ” Research</div>
                                <div id="n-pa-analyst" class="bg-purple-900 border border-purple-400 px-2 py-0.5 rounded">ğŸ“Š Analyst</div>
                                <div id="n-pa-writer" class="bg-pink-900 border border-pink-400 px-2 py-0.5 rounded">âœï¸ Writer</div>
                            </div>
                        </div>
                        <div class="text-gray-600">â†“</div>
                        <div id="n-pa-collector" class="bg-indigo-900 border border-indigo-500 px-2 py-0.5 rounded">ğŸ“‹ Collector</div>
                        <div class="text-gray-600">â†“</div>
                        <div id="n-pa-__END__" class="bg-red-900 border border-red-500 px-2 py-0.5 rounded font-bold">END</div>
                    </div>
                </div>

                <!-- Adaptive RAG å·¥ä½œæµå›¾ -->
                <div id="adaptiveRagGraph" class="mt-3 p-2 bg-gray-900/50 rounded border border-rose-500/30 hidden">
                    <div class="text-rose-400 text-xs font-bold mb-2">ğŸ“– Adaptive RAG æµç¨‹å›¾</div>
                    <div class="flex flex-col items-center space-y-1 text-xs">
                        <div id="n-rag-__START__" class="bg-green-900 border border-green-500 px-2 py-0.5 rounded font-bold">START</div>
                        <div class="text-gray-600">â†“</div>
                        <div id="n-rag-query_analyzer" class="bg-rose-900 border-2 border-rose-500 px-3 py-1 rounded">ğŸ” Query Analyzer</div>
                        <div class="text-rose-400 text-[10px]">â†“ æŸ¥è¯¢è·¯ç”±</div>
                        <div class="flex gap-1 text-[9px]">
                            <div class="flex flex-col items-center">
                                <div class="text-gray-500">simple</div>
                                <div id="n-rag-direct_generate" class="bg-yellow-900 border border-yellow-500 px-1 py-0.5 rounded">âš¡Direct</div>
                            </div>
                            <div class="flex flex-col items-center">
                                <div class="text-gray-500">standard</div>
                                <div id="n-rag-standard_retrieve" class="bg-blue-900 border border-blue-500 px-1 py-0.5 rounded">ğŸ“šRetrieve</div>
                            </div>
                            <div class="flex flex-col items-center">
                                <div class="text-gray-500">complex</div>
                                <div id="n-rag-multi_step_retrieve" class="bg-purple-900 border border-purple-500 px-1 py-0.5 rounded">ğŸ”„Multi</div>
                            </div>
                        </div>
                        <div class="text-gray-600">â†“</div>
                        <div id="n-rag-grade_documents" class="bg-cyan-900 border border-cyan-500 px-2 py-0.5 rounded">ğŸ“Š Grade Docs</div>
                        <div class="flex items-center gap-1 text-[9px]">
                            <div class="text-green-400">relevantâ†’</div>
                            <div class="text-red-400">notâ†’</div>
                            <div id="n-rag-query_transform" class="bg-orange-900 border border-orange-500 px-1 py-0.5 rounded">âœï¸Transform</div>
                            <div class="text-orange-400">â†©</div>
                        </div>
                        <div class="text-gray-600">â†“</div>
                        <div id="n-rag-generate_answer" class="bg-emerald-900 border border-emerald-500 px-2 py-0.5 rounded">ğŸ’¡ Generate</div>
                        <div class="text-gray-600">â†“</div>
                        <div id="n-rag-grade_answer" class="bg-pink-900 border border-pink-500 px-2 py-0.5 rounded">âœ… Grade Answer</div>
                        <div class="text-[9px] text-gray-500">(å¹»è§‰æ£€æµ‹ | è´¨é‡è¯„ä¼°)</div>
                        <div class="text-gray-600">â†“</div>
                        <div id="n-rag-__END__" class="bg-red-900 border border-red-500 px-2 py-0.5 rounded font-bold">END</div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§è¾“å‡º -->
            <div class="space-y-3">
                <div class="bg-gray-800 rounded-lg p-3">
                    <h2 class="font-semibold mb-1 text-cyan-400 text-sm">æ¶ˆæ¯</h2>
                    <div id="msgBox" class="h-28 overflow-y-auto text-xs space-y-1">
                        <p class="text-gray-500">ç­‰å¾…æ‰§è¡Œ...</p>
                    </div>
                </div>
                <div class="bg-gray-800 rounded-lg p-3">
                    <h2 class="font-semibold mb-1 text-amber-400 text-sm">æ‰§è¡Œæ—¥å¿—</h2>
                    <div id="logBox" class="h-28 overflow-y-auto text-xs font-mono space-y-1">
                        <p class="text-gray-500">ç­‰å¾…æ‰§è¡Œ...</p>
                    </div>
                </div>
                <div class="bg-gray-800 rounded-lg p-3">
                    <h2 class="font-semibold mb-1 text-green-400 text-sm">æœ€ç»ˆç»“æœ</h2>
                    <pre id="resultBox" class="text-xs text-gray-400 whitespace-pre-wrap">ç­‰å¾…å®Œæˆ...</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api/comprehensive';
        let executedNodes = [];
        
        function setInput(t) { document.getElementById('userInput').value = t; }
        function getThreadId() { return document.getElementById('threadIdInput').value || 'default-thread'; }
        
        function clearAllNodes() {
            document.querySelectorAll('[id^="n-"]').forEach(n => n.classList.remove('node-active','node-completed','node-waiting','ring-2','ring-white'));
        }
        
        // å½“å‰æ¨¡å¼: 'workflow' æˆ– 'multiagent'
        let currentMode = 'workflow';
        
        // è½¬æ¢èŠ‚ç‚¹åç§°ä¸ºDOM IDï¼ˆå­å›¾èŠ‚ç‚¹ subgraph:xxx -> sg-xxxï¼‰
        function toNodeId(name) {
            if (name.startsWith('subgraph:')) {
                return 'n-sg-' + name.replace('subgraph:', '');
            }
            // å¤šæ™ºèƒ½ä½“æ¨¡å¼ä½¿ç”¨ ma- å‰ç¼€
            if (currentMode === 'multiagent') {
                return 'n-ma-' + name;
            }
            // å¹¶è¡Œæ¨¡å¼ä½¿ç”¨ pa- å‰ç¼€
            if (currentMode === 'parallel') {
                return 'n-pa-' + name;
            }
            // Adaptive RAGæ¨¡å¼ä½¿ç”¨ rag- å‰ç¼€
            if (currentMode === 'rag') {
                return 'n-rag-' + name;
            }
            return 'n-' + name;
        }
        
        function switchToWorkflowMode() {
            currentMode = 'workflow';
            document.getElementById('multiAgentGraph').classList.add('hidden');
            document.getElementById('parallelAgentGraph').classList.add('hidden');
            document.getElementById('adaptiveRagGraph').classList.add('hidden');
        }
        
        function switchToMultiAgentMode() {
            currentMode = 'multiagent';
            document.getElementById('multiAgentGraph').classList.remove('hidden');
            document.getElementById('parallelAgentGraph').classList.add('hidden');
            document.getElementById('adaptiveRagGraph').classList.add('hidden');
        }
        
        function switchToParallelMode() {
            currentMode = 'parallel';
            document.getElementById('multiAgentGraph').classList.add('hidden');
            document.getElementById('parallelAgentGraph').classList.remove('hidden');
            document.getElementById('adaptiveRagGraph').classList.add('hidden');
        }
        
        function switchToRagMode() {
            currentMode = 'rag';
            document.getElementById('multiAgentGraph').classList.add('hidden');
            document.getElementById('parallelAgentGraph').classList.add('hidden');
            document.getElementById('adaptiveRagGraph').classList.remove('hidden');
        }
        
        function markCompleted(name) {
            const n = document.getElementById(toNodeId(name));
            if (n) { n.classList.remove('node-active','node-waiting'); n.classList.add('node-completed'); }
        }
        
        function highlightActive(name) {
            executedNodes.forEach(n => markCompleted(n));
            // å¤„ç†å­å›¾èŠ‚ç‚¹ï¼ˆåŒæ—¶é«˜äº®å­å›¾å®¹å™¨ï¼‰
            if (name.startsWith('subgraph:')) {
                const parentNode = document.getElementById('n-health_subgraph');
                if (parentNode) parentNode.classList.add('node-active');
            }
            const node = document.getElementById(toNodeId(name));
            if (node) { node.classList.remove('node-completed','node-waiting'); node.classList.add('node-active','ring-2','ring-white'); }
            const displayName = name.startsWith('subgraph:') ? 'å­å›¾:' + name.replace('subgraph:', '') : name;
            document.getElementById('graphStatus').textContent = '(æ‰§è¡Œ: ' + displayName + ')';
            document.getElementById('graphStatus').className = 'text-xs font-normal text-green-400';
        }
        
        function markWaiting(name) {
            const n = document.getElementById(toNodeId(name));
            if (n) { n.classList.remove('node-active','node-completed'); n.classList.add('node-waiting','ring-2','ring-yellow-400'); }
            document.getElementById('graphStatus').textContent = '(ç­‰å¾…äººå·¥)';
            document.getElementById('graphStatus').className = 'text-xs font-normal text-yellow-400';
        }
        
        function addToPath(name) {
            if (!executedNodes.includes(name)) executedNodes.push(name);
            document.getElementById('executionPath').innerHTML = executedNodes.map((n, i) => {
                const isSubgraph = n.startsWith('subgraph:');
                const displayName = isSubgraph ? n.replace('subgraph:', 'ğŸ¥') : n;
                const bgClass = isSubgraph ? 'bg-purple-900/50' : 'bg-green-900/50';
                return `<span class="px-1 py-0.5 ${bgClass} rounded">${displayName}</span>${i < executedNodes.length - 1 ? '<span class="text-gray-500">â†’</span>' : ''}`;
            }).join('');
        }
        
        function updateDisp(d) {
            const node = d.currentStep || d.node || '-';
            const displayNode = node.startsWith('subgraph:') ? 'ğŸ¥' + node.replace('subgraph:', '') : node;
            document.getElementById('dispNode').textContent = displayNode;
            document.getElementById('dispIntent').textContent = d.intent || '-';
            document.getElementById('dispStep').textContent = d.stepCount || d.totalSteps || '0';
            document.getElementById('dispStatus').textContent = d.status || d.workflowStatus || 'running';
            if (node && node !== '-') { highlightActive(node); addToPath(node); }
        }
        
        function addMsg(t, c='blue') {
            const box = document.getElementById('msgBox');
            if (box.querySelector('.text-gray-500')) box.innerHTML = '';
            box.innerHTML += `<div class="p-1 rounded bg-${c}-900/30 border border-${c}-700 text-${c}-300">${t}</div>`;
            box.scrollTop = box.scrollHeight;
        }
        
        function addLog(t) {
            const box = document.getElementById('logBox');
            if (box.querySelector('.text-gray-500')) box.innerHTML = '';
            box.innerHTML += `<div class="text-gray-400">${t}</div>`;
            box.scrollTop = box.scrollHeight;
        }
        
        function reset() {
            clearAllNodes();
            executedNodes = [];
            document.getElementById('executionPath').innerHTML = '<span class="text-gray-600">å¼€å§‹...</span>';
            document.getElementById('msgBox').innerHTML = '<p class="text-gray-500">æ‰§è¡Œä¸­...</p>';
            document.getElementById('logBox').innerHTML = '<p class="text-gray-500">æ‰§è¡Œä¸­...</p>';
            document.getElementById('resultBox').textContent = 'æ‰§è¡Œä¸­...';
            document.getElementById('approvalPanel').classList.add('hidden');
            document.getElementById('graphStatus').textContent = '(æ‰§è¡Œä¸­)';
            highlightActive('__START__');
            addToPath('START');
        }
        
        function markComplete() {
            executedNodes.forEach(n => markCompleted(n));
            highlightActive('__END__');
            addToPath('END');
            document.getElementById('graphStatus').textContent = '(å®Œæˆ)';
            document.getElementById('graphStatus').className = 'text-xs font-normal text-green-400';
        }

        async function executeInvoke() {
            const input = document.getElementById('userInput').value || 'é»˜è®¤';
            switchToWorkflowMode();
            reset();
            addLog('åŒæ­¥æ‰§è¡Œ: ' + input);
            const res = await fetch(`${API}/invoke`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userInput:input})});
            const d = await res.json();
            if (d.success) {
                (d.executionLog || []).forEach((l, i) => setTimeout(() => addLog(l), i * 200));
                setTimeout(() => {
                    (d.messages || []).forEach(m => addMsg(m));
                    updateDisp(d);
                    document.getElementById('resultBox').textContent = d.finalResult || 'å®Œæˆ';
                    markComplete();
                }, (d.executionLog?.length || 0) * 200 + 100);
            } else addMsg('é”™è¯¯: ' + d.error, 'red');
        }

        async function executeStream() {
            const input = document.getElementById('userInput').value || 'é»˜è®¤';
            switchToWorkflowMode();
            reset();
            addLog('æµå¼æ‰§è¡Œ: ' + input);
            
            const ANIMATION_DELAY = 600; // æ¯ä¸ªèŠ‚ç‚¹é«˜äº®çš„åœç•™æ—¶é—´(ms)
            let eventQueue = [];
            let isProcessing = false;
            let streamEnded = false;
            
            // å¤„ç†é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼ˆå¸¦å»¶è¿Ÿï¼‰
            function processQueue() {
                if (isProcessing || eventQueue.length === 0) {
                    if (streamEnded && eventQueue.length === 0) {
                        setTimeout(() => {
                            markComplete();
                            document.getElementById('dispStatus').textContent = 'completed';
                            addLog('âœ… æµå¼æ‰§è¡Œå®Œæˆ');
                        }, ANIMATION_DELAY);
                    }
                    return;
                }
                isProcessing = true;
                const d = eventQueue.shift();
                const node = d.node || d.currentStep;
                if (node) { highlightActive(node); addToPath(node); }
                updateDisp(d);
                if (d.messages?.length) addMsg(d.messages[d.messages.length-1]);
                addLog(`[${node}] step ${d.stepCount}`);
                setTimeout(() => {
                    isProcessing = false;
                    processQueue();
                }, ANIMATION_DELAY);
            }
            
            const es = new EventSource(`${API}/stream?userInput=${encodeURIComponent(input)}`);
            es.onmessage = e => {
                try {
                    const d = JSON.parse(e.data);
                    eventQueue.push(d);
                    processQueue();
                } catch (err) { console.error(err); }
            };
            es.onerror = () => { 
                es.close(); 
                streamEnded = true;
                processQueue(); // è§¦å‘æœ€ç»ˆå®Œæˆå¤„ç†
            };
        }

        // ThreadIdæ‰§è¡Œï¼ˆä¸å¸¦HITLä¸­æ–­ï¼Œå®Œæ•´æ‰§è¡Œï¼‰
        async function startWithThread() {
            const input = document.getElementById('userInput').value || 'æŸ¥è¯¢å¤©æ°”';
            const threadId = getThreadId();
            switchToWorkflowMode();
            reset();
            addLog(`ğŸ“¦ ThreadIdæ‰§è¡Œ(æ— ä¸­æ–­) [${threadId}]: ${input}`);
            addMsg('æ¨¡å¼: ThreadIdæ‰§è¡Œï¼ˆä¸ä¸­æ–­ï¼Œå®Œæ•´æ‰§è¡Œï¼‰', 'cyan');
            const res = await fetch(`${API}/start-with-thread`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userInput:input, threadId})});
            const d = await res.json();
            if (d.success) {
                (d.executionEvents || []).forEach((evt, i) => setTimeout(() => { if (evt.node) { highlightActive(evt.node); addToPath(evt.node); } }, i * 200));
                (d.messages || []).forEach(m => addMsg(m));
                (d.executionLog || []).forEach(l => addLog(l));
                updateDisp({currentStep: d.currentNode, intent: d.intent, stepCount: d.stepCount, status: 'completed'});
                document.getElementById('resultBox').textContent = d.message;
                markComplete();
                setTimeout(() => loadMemory(), 1000);
            } else addMsg('é”™è¯¯: ' + d.error, 'red');
        }

        // äººåœ¨å›è·¯æ¨¡å¼ï¼ˆå±é™©æ“ä½œä¼šä¸­æ–­ç­‰å¾…å®¡æ‰¹ï¼‰
        async function startWithHitl() {
            const input = document.getElementById('userInput').value || 'åˆ é™¤æ•°æ®';
            const threadId = getThreadId();
            switchToWorkflowMode();
            reset();
            addLog(`ğŸ”’ HITLæ¨¡å¼å¯åŠ¨ [${threadId}]: ${input}`);
            addMsg('æ¨¡å¼: äººåœ¨å›è·¯ï¼ˆå±é™©æ“ä½œä¼šä¸­æ–­ç­‰å¾…å®¡æ‰¹ï¼‰', 'orange');
            const res = await fetch(`${API}/start-hitl`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userInput:input, threadId})});
            const d = await res.json();
            if (d.success) {
                (d.executionEvents || []).forEach((evt, i) => setTimeout(() => { if (evt.node) { highlightActive(evt.node); addToPath(evt.node); } }, i * 200));
                (d.messages || []).forEach(m => addMsg(m));
                (d.executionLog || []).forEach(l => addLog(l));
                updateDisp({currentStep: d.currentNode, intent: d.intent, stepCount: d.stepCount, status: d.waitingForApproval ? 'waiting' : 'completed'});
                if (d.waitingForApproval) {
                    document.getElementById('approvalMsg').textContent = `ThreadId: ${threadId} - ${d.message}`;
                    document.getElementById('approvalPanel').classList.remove('hidden');
                    setTimeout(() => markWaiting('approval_request'), 500);
                    addLog('â¸ï¸ ç­‰å¾…äººå·¥å®¡æ‰¹...');
                    addMsg(`ğŸ”’ è®°å¿†å·²ä¿å­˜ï¼Œç­‰å¾…å®¡æ‰¹ [${threadId}]`, 'yellow');
                } else {
                    document.getElementById('resultBox').textContent = d.finalResult || d.message;
                    markComplete();
                }
                setTimeout(() => loadMemory(), 1000);
            } else addMsg('é”™è¯¯: ' + d.error, 'red');
        }

        async function loadMemory() {
            const threadId = getThreadId();
            const panel = document.getElementById('memoryPanel');
            panel.innerHTML = '<p class="text-gray-400">åŠ è½½ä¸­...</p>';
            try {
                const res = await fetch(`${API}/memory/${threadId}`);
                const d = await res.json();
                if (d.success) {
                    panel.innerHTML = `
                        <div class="space-y-1">
                            <div class="text-purple-400 font-bold">${d.threadId}</div>
                            <div class="text-gray-400">${d.statusDescription}</div>
                            <div>èŠ‚ç‚¹: <span class="text-blue-400">${d.snapshot?.currentNode || '-'}</span></div>
                            <div>æ„å›¾: <span class="text-purple-400">${d.state?.intent || '-'}</span></div>
                            <div>æ­¥æ•°: <span class="text-green-400">${d.state?.stepCount || 0}</span></div>
                            <div>å®¡æ‰¹: <span class="text-yellow-400">${d.state?.approvalStatus || '-'}</span></div>
                            <div>å¥åº·ç±»å‹: <span class="text-pink-400">${d.state?.healthCategory || '-'}</span></div>
                        </div>`;
                    addLog(`ğŸ“š åŠ è½½è®°å¿† [${threadId}]`);
                } else panel.innerHTML = `<p class="text-red-400">${d.error}</p>`;
            } catch (e) { panel.innerHTML = `<p class="text-red-400">${e.message}</p>`; }
        }

        async function continueThread() {
            const threadId = getThreadId();
            const memRes = await fetch(`${API}/memory/${threadId}`);
            const memData = await memRes.json();
            if (!memData.success) { addMsg(`ThreadId [${threadId}] æ— è®°å¿†`, 'red'); return; }
            if (memData.state?.approvalStatus !== 'waiting') { addMsg(`ThreadId [${threadId}] ä¸åœ¨ç­‰å¾…çŠ¶æ€`, 'yellow'); return; }
            const decision = confirm(`ThreadId: ${threadId}\n\nç¡®å®š=æ‰¹å‡†\nå–æ¶ˆ=æ‹’ç»`);
            await handleApproval(decision ? 'approve' : 'reject');
        }

        async function handleApproval(action) {
            const threadId = getThreadId();
            document.getElementById('approvalPanel').classList.add('hidden');
            addMsg(`å†³ç­–: ${action === 'approve' ? 'âœ…æ‰¹å‡†' : 'âŒæ‹’ç»'}`, action === 'approve' ? 'green' : 'red');
            addLog(`å®¡æ‰¹: ${action}`);
            highlightActive('approval_handler');
            addToPath('approval_handler');
            const res = await fetch(`${API}/continue-with-thread`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({threadId, decision:action})});
            const d = await res.json();
            if (d.success) {
                (d.messages || []).forEach(m => addMsg(m));
                (d.executionLog || []).forEach(l => addLog(l));
                setTimeout(() => {
                    if (d.approvalStatus === 'approved') { highlightActive('dangerous_operation'); addToPath('dangerous_operation'); }
                    else { highlightActive('rejection_handler'); addToPath('rejection_handler'); }
                }, 300);
                setTimeout(() => {
                    if (d.approvalStatus === 'approved') { highlightActive('result_aggregator'); addToPath('result_aggregator'); }
                    updateDisp({currentStep: d.approvalStatus === 'approved' ? 'result_aggregator' : 'rejection_handler', intent: 'dangerous', stepCount: d.totalSteps, status: d.workflowStatus});
                    document.getElementById('resultBox').textContent = d.finalResult || d.message;
                    markComplete();
                    setTimeout(() => loadMemory(), 500);
                }, 600);
            } else addMsg('é”™è¯¯: ' + d.error, 'red');
        }

        // ========== å¤šæ™ºèƒ½ä½“æ‰§è¡Œå‡½æ•° ==========
        
        async function multiAgentInvoke() {
            const input = document.getElementById('userInput').value || 'å…¨éƒ¨æ™ºèƒ½ä½“åä½œåˆ†æ';
            switchToMultiAgentMode();
            reset();
            addLog(`ğŸ¤– å¤šæ™ºèƒ½ä½“åŒæ­¥æ‰§è¡Œ: ${input}`);
            addMsg('æ¨¡å¼: å¤šæ™ºèƒ½ä½“åä½œ (Supervisoræ¨¡å¼)', 'amber');
            
            const res = await fetch(`${API}/multi-agent/invoke`, {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({userInput: input})
            });
            const d = await res.json();
            
            if (d.success) {
                // æ˜¾ç¤ºæ‰§è¡Œæ—¥å¿—ï¼ˆå¸¦åŠ¨ç”»ï¼‰
                const logs = d.executionLog || [];
                logs.forEach((l, i) => {
                    setTimeout(() => {
                        addLog(l);
                        // æ ¹æ®æ—¥å¿—å†…å®¹é«˜äº®å¯¹åº”èŠ‚ç‚¹
                        if (l.includes('Supervisor')) { highlightActive('supervisor'); addToPath('supervisor'); }
                        else if (l.includes('Research')) { highlightActive('research_agent'); addToPath('research_agent'); }
                        else if (l.includes('Analyst')) { highlightActive('analyst_agent'); addToPath('analyst_agent'); }
                        else if (l.includes('Writer')) { highlightActive('writer_agent'); addToPath('writer_agent'); }
                        else if (l.includes('Aggregator')) { highlightActive('aggregator'); addToPath('aggregator'); }
                    }, i * 400);
                });
                
                // æ˜¾ç¤ºæ¶ˆæ¯
                setTimeout(() => {
                    (d.messages || []).forEach(m => addMsg(m));
                    updateDisp({currentStep: 'aggregator', intent: d.intent, stepCount: d.totalSteps, status: 'completed'});
                    document.getElementById('resultBox').textContent = d.finalResult || 'å¤šæ™ºèƒ½ä½“åä½œå®Œæˆ';
                    markComplete();
                }, logs.length * 400 + 200);
            } else {
                addMsg('é”™è¯¯: ' + d.error, 'red');
            }
        }
        
        async function multiAgentStream() {
            const input = document.getElementById('userInput').value || 'å…¨éƒ¨æ™ºèƒ½ä½“åä½œåˆ†æ';
            switchToMultiAgentMode();
            reset();
            addLog(`ğŸ¤–ğŸŒŠ å¤šæ™ºèƒ½ä½“æµå¼æ‰§è¡Œ: ${input}`);
            addMsg('æ¨¡å¼: å¤šæ™ºèƒ½ä½“æµå¼åä½œ (Supervisoræ¨¡å¼)', 'amber');
            
            const ANIMATION_DELAY = 700;
            let eventQueue = [];
            let isProcessing = false;
            let streamEnded = false;
            
            function processQueue() {
                if (isProcessing || eventQueue.length === 0) {
                    if (streamEnded && eventQueue.length === 0) {
                        setTimeout(() => {
                            markComplete();
                            document.getElementById('dispStatus').textContent = 'completed';
                            addLog('âœ… å¤šæ™ºèƒ½ä½“åä½œå®Œæˆ');
                        }, ANIMATION_DELAY);
                    }
                    return;
                }
                isProcessing = true;
                const d = eventQueue.shift();
                const node = d.node || d.currentStep;
                if (node) { highlightActive(node); addToPath(node); }
                updateDisp(d);
                if (d.messages?.length) addMsg(d.messages[d.messages.length-1]);
                addLog(`[${node}] step ${d.stepCount}`);
                // æ˜¾ç¤ºæ™ºèƒ½ä½“è¾“å‡º
                if (d.toolResults?.length) {
                    const lastResult = d.toolResults[d.toolResults.length-1];
                    if (lastResult) addMsg(lastResult.substring(0, 100) + '...', 'amber');
                }
                setTimeout(() => {
                    isProcessing = false;
                    processQueue();
                }, ANIMATION_DELAY);
            }
            
            const es = new EventSource(`${API}/multi-agent/stream?userInput=${encodeURIComponent(input)}`);
            es.onmessage = e => {
                try {
                    const d = JSON.parse(e.data);
                    eventQueue.push(d);
                    processQueue();
                } catch (err) { console.error(err); }
            };
            es.onerror = () => { 
                es.close(); 
                streamEnded = true;
                processQueue();
            };
        }

        // ========== å¹¶è¡Œå¤šæ™ºèƒ½ä½“æ‰§è¡Œå‡½æ•° ==========
        
        async function parallelAgentInvoke() {
            const input = document.getElementById('userInput').value || 'å…¨éƒ¨æ™ºèƒ½ä½“åä½œåˆ†æ';
            switchToParallelMode();
            reset();
            addLog(`âš¡ å¹¶è¡Œå¤šæ™ºèƒ½ä½“åŒæ­¥æ‰§è¡Œ: ${input}`);
            addMsg('æ¨¡å¼: âš¡ å¹¶è¡Œå¤šæ™ºèƒ½ä½“åä½œ (æ‰€æœ‰AgentåŒæ—¶æ‰§è¡Œ)', 'green');
            
            const res = await fetch(`${API}/parallel-agent/invoke`, {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({userInput: input})
            });
            const d = await res.json();
            
            if (d.success) {
                // æ˜¾ç¤ºæ‰§è¡Œæ—¥å¿—ï¼ˆå¸¦åŠ¨ç”»ï¼‰
                const logs = d.executionLog || [];
                
                // å…ˆé«˜äº®dispatcher
                setTimeout(() => {
                    highlightActive('dispatcher');
                    addToPath('dispatcher');
                    addLog('[dispatcher] åˆ†å‘ä»»åŠ¡');
                }, 300);
                
                // åŒæ—¶é«˜äº®æ‰€æœ‰å¹¶è¡ŒAgent
                setTimeout(() => {
                    highlightActive('parallel_executor');
                    addToPath('parallel_executor');
                    // åŒæ—¶é«˜äº®ä¸‰ä¸ªAgent
                    ['n-pa-research', 'n-pa-analyst', 'n-pa-writer'].forEach(id => {
                        const node = document.getElementById(id);
                        if (node) node.classList.add('node-active', 'ring-2', 'ring-white');
                    });
                    addMsg('âš¡ ä¸‰ä¸ªAgentå¹¶è¡Œæ‰§è¡Œä¸­...', 'green');
                }, 600);
                
                // æ˜¾ç¤ºå¹¶è¡Œæ—¥å¿—
                logs.forEach((l, i) => {
                    setTimeout(() => addLog(l), 900 + i * 150);
                });
                
                // é«˜äº®collectorå¹¶å®Œæˆ
                setTimeout(() => {
                    ['n-pa-research', 'n-pa-analyst', 'n-pa-writer'].forEach(id => {
                        const node = document.getElementById(id);
                        if (node) { node.classList.remove('node-active'); node.classList.add('node-completed'); }
                    });
                    highlightActive('collector');
                    addToPath('collector');
                    (d.messages || []).forEach(m => addMsg(m));
                    updateDisp({currentStep: 'collector', intent: d.intent, stepCount: d.totalSteps, status: 'completed'});
                    document.getElementById('resultBox').textContent = d.finalResult || 'å¹¶è¡Œåä½œå®Œæˆ';
                    markComplete();
                }, logs.length * 150 + 1200);
            } else {
                addMsg('é”™è¯¯: ' + d.error, 'red');
            }
        }
        
        async function parallelAgentStream() {
            const input = document.getElementById('userInput').value || 'å…¨éƒ¨æ™ºèƒ½ä½“åä½œåˆ†æ';
            switchToParallelMode();
            reset();
            addLog(`âš¡ğŸŒŠ å¹¶è¡Œå¤šæ™ºèƒ½ä½“æµå¼æ‰§è¡Œ: ${input}`);
            addMsg('æ¨¡å¼: âš¡ å¹¶è¡Œå¤šæ™ºèƒ½ä½“æµå¼åä½œ', 'green');
            
            const ANIMATION_DELAY = 800;
            let eventQueue = [];
            let isProcessing = false;
            let streamEnded = false;
            
            function processQueue() {
                if (isProcessing || eventQueue.length === 0) {
                    if (streamEnded && eventQueue.length === 0) {
                        setTimeout(() => {
                            markComplete();
                            document.getElementById('dispStatus').textContent = 'completed';
                            addLog('âœ… å¹¶è¡Œåä½œå®Œæˆ');
                        }, ANIMATION_DELAY);
                    }
                    return;
                }
                isProcessing = true;
                const d = eventQueue.shift();
                const node = d.node || d.currentStep;
                
                if (node) { 
                    highlightActive(node); 
                    addToPath(node); 
                    
                    // å¦‚æœæ˜¯parallel_executorï¼ŒåŒæ—¶é«˜äº®æ‰€æœ‰Agent
                    if (node === 'parallel_executor') {
                        ['n-pa-research', 'n-pa-analyst', 'n-pa-writer'].forEach(id => {
                            const n = document.getElementById(id);
                            if (n) n.classList.add('node-active', 'ring-2', 'ring-white');
                        });
                        addMsg('âš¡ ä¸‰ä¸ªAgentå¹¶è¡Œæ‰§è¡Œä¸­...', 'green');
                    }
                }
                updateDisp(d);
                if (d.messages?.length) addMsg(d.messages[d.messages.length-1]);
                
                // æ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—
                (d.executionLog || []).forEach(l => addLog(l));
                
                setTimeout(() => {
                    // å®Œæˆparallel_executoråæ ‡è®°æ‰€æœ‰Agentä¸ºå®Œæˆ
                    if (node === 'parallel_executor') {
                        ['n-pa-research', 'n-pa-analyst', 'n-pa-writer'].forEach(id => {
                            const n = document.getElementById(id);
                            if (n) { n.classList.remove('node-active'); n.classList.add('node-completed'); }
                        });
                    }
                    isProcessing = false;
                    processQueue();
                }, ANIMATION_DELAY);
            }
            
            const es = new EventSource(`${API}/parallel-agent/stream?userInput=${encodeURIComponent(input)}`);
            es.onmessage = e => {
                try {
                    const d = JSON.parse(e.data);
                    eventQueue.push(d);
                    processQueue();
                } catch (err) { console.error(err); }
            };
            es.onerror = () => { 
                es.close(); 
                streamEnded = true;
                processQueue();
            };
        }

        // ========== Adaptive RAG æ‰§è¡Œå‡½æ•° ==========
        
        async function adaptiveRagInvoke() {
            const input = document.getElementById('userInput').value || 'LangGraphçš„ä½¿ç”¨æ–¹æ³•';
            switchToRagMode();
            reset();
            addLog(`ğŸ“– Adaptive RAG åŒæ­¥æ‰§è¡Œ: ${input}`);
            addMsg('æ¨¡å¼: ğŸ“– Adaptive RAG (è‡ªé€‚åº”æ£€ç´¢å¢å¼ºç”Ÿæˆ)', 'rose');
            
            const res = await fetch(`${API}/adaptive-rag/invoke`, {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({userInput: input})
            });
            const d = await res.json();
            
            if (d.success) {
                const logs = d.executionLog || [];
                logs.forEach((l, i) => {
                    setTimeout(() => {
                        addLog(l);
                        // æ ¹æ®æ—¥å¿—å†…å®¹é«˜äº®å¯¹åº”èŠ‚ç‚¹
                        if (l.includes('Query Analyzer')) { highlightActive('query_analyzer'); addToPath('query_analyzer'); }
                        else if (l.includes('Direct Generate')) { highlightActive('direct_generate'); addToPath('direct_generate'); }
                        else if (l.includes('Standard Retrieve')) { highlightActive('standard_retrieve'); addToPath('standard_retrieve'); }
                        else if (l.includes('Multi-Step')) { highlightActive('multi_step_retrieve'); addToPath('multi_step_retrieve'); }
                        else if (l.includes('Grade Documents')) { highlightActive('grade_documents'); addToPath('grade_documents'); }
                        else if (l.includes('Query Transform')) { highlightActive('query_transform'); addToPath('query_transform'); }
                        else if (l.includes('Generate Answer')) { highlightActive('generate_answer'); addToPath('generate_answer'); }
                        else if (l.includes('Grade Answer')) { highlightActive('grade_answer'); addToPath('grade_answer'); }
                    }, i * 400);
                });
                
                setTimeout(() => {
                    (d.messages || []).forEach(m => addMsg(m));
                    updateDisp({currentStep: 'grade_answer', intent: d.intent, stepCount: d.totalSteps, status: 'completed'});
                    document.getElementById('resultBox').textContent = d.finalResult || 'Adaptive RAGå®Œæˆ';
                    markComplete();
                }, logs.length * 400 + 200);
            } else {
                addMsg('é”™è¯¯: ' + d.error, 'red');
            }
        }
        
        async function adaptiveRagStream() {
            const input = document.getElementById('userInput').value || 'LangGraphçš„ä½¿ç”¨æ–¹æ³•';
            switchToRagMode();
            reset();
            addLog(`ğŸ“–ğŸŒŠ Adaptive RAG æµå¼æ‰§è¡Œ: ${input}`);
            addMsg('æ¨¡å¼: ğŸ“– Adaptive RAG æµå¼ (è‡ªé€‚åº”æ£€ç´¢)', 'rose');
            
            const ANIMATION_DELAY = 700;
            let eventQueue = [];
            let isProcessing = false;
            let streamEnded = false;
            
            function processQueue() {
                if (isProcessing || eventQueue.length === 0) {
                    if (streamEnded && eventQueue.length === 0) {
                        setTimeout(() => {
                            markComplete();
                            document.getElementById('dispStatus').textContent = 'completed';
                            addLog('âœ… Adaptive RAG å®Œæˆ');
                        }, ANIMATION_DELAY);
                    }
                    return;
                }
                isProcessing = true;
                const d = eventQueue.shift();
                const node = d.node || d.currentStep;
                if (node) { highlightActive(node); addToPath(node); }
                updateDisp(d);
                if (d.messages?.length) addMsg(d.messages[d.messages.length-1]);
                addLog(`[${node}] step ${d.stepCount}`);
                if (d.toolResults?.length) {
                    const lastResult = d.toolResults[d.toolResults.length-1];
                    if (lastResult) addMsg(lastResult.substring(0, 80) + '...', 'rose');
                }
                setTimeout(() => {
                    isProcessing = false;
                    processQueue();
                }, ANIMATION_DELAY);
            }
            
            const es = new EventSource(`${API}/adaptive-rag/stream?userInput=${encodeURIComponent(input)}`);
            es.onmessage = e => {
                try {
                    const d = JSON.parse(e.data);
                    eventQueue.push(d);
                    processQueue();
                } catch (err) { console.error(err); }
            };
            es.onerror = () => { 
                es.close(); 
                streamEnded = true;
                processQueue();
            };
        }
    </script>
</body>
</html>
